# Email Setup Guide - User Invitation System

This guide explains how to set up the email functionality for user invitations using Supabase Edge Functions.

## 🚀 Quick Start

### 1. Deploy the Edge Function

```bash
# Make sure you have Supabase CLI installed
npm install -g supabase

# Login to Supabase
supabase login

# Deploy the Edge Function
./deploy-edge-function.sh
```

### 2. Test the Invitation System

1. Go to your corporate dashboard
2. Navigate to User Management → Invitations
3. Send a test invitation
4. Check the browser console for invitation details (currently logged for manual sending)

## 📧 Current Implementation

### Edge Function: `send-invitation-email`

**Location:** `supabase/functions/send-invitation-email/`

**Features:**
- ✅ Uses Supabase's built-in email service
- ✅ Generates secure invitation links
- ✅ Includes custom user metadata (company, role, inviter)
- ✅ Automatic email delivery via Supabase Auth
- ✅ Graceful fallback if email fails
- ✅ Environment-aware URLs (VITE_APP_URL)

### Supabase Email Integration

The system uses Supabase's built-in email service which provides:
- **Secure invitation links** generated by Supabase Auth
- **Custom user metadata** (company, role, inviter info)
- **Automatic email delivery** through Supabase's email service
- **Built-in email templates** (customizable in Supabase dashboard)
- **Email delivery tracking** and error handling

## 🔧 Production Setup

### Supabase Email Configuration

1. **Configure Email in Supabase Dashboard:**
   - Go to **Authentication > Settings** in your Supabase project
   - Scroll down to **Email Templates** section
   - Configure **Invite user** template if needed
   - Set up **SMTP settings** for custom email provider (optional)

2. **Set Environment Variables:**
   ```bash
   # Set your app URL
   supabase secrets set VITE_APP_URL=https://your-app-domain.com
   ```

3. **Test Email Delivery:**
   - Go to **Authentication > Users** in Supabase dashboard
   - Click **Invite user** to test email delivery
   - Check email logs in **Authentication > Logs**

4. **Customize Email Templates (Optional):**
   - Edit templates in **Authentication > Settings > Email Templates**
   - Use variables like `{{ .ConfirmationURL }}`, `{{ .Token }}`, etc.
   - Preview templates before saving

### Advanced Configuration

If you need custom email providers, you can configure SMTP in Supabase:

1. **Set up Custom SMTP:**
   - Go to **Authentication > Settings > SMTP Settings**
   - Configure your email provider (SendGrid, AWS SES, Mailgun, etc.)
   - Test the connection
   - Save settings

2. **Email Provider Examples:**
   - **SendGrid**: Use your SendGrid SMTP credentials
   - **AWS SES**: Use SES SMTP settings
   - **Mailgun**: Use Mailgun SMTP credentials
   - **Gmail**: Use Gmail SMTP for testing

3. **Custom Templates:**
   - Edit email templates in **Authentication > Settings > Email Templates**
   - Use Supabase template variables
   - Test with preview functionality

## 🧪 Testing

### Local Development

1. **Start Supabase locally:**
   ```bash
   supabase start
   ```

2. **Test the function:**
   ```bash
   curl -X POST 'http://localhost:54321/functions/v1/send-invitation-email' \
     -H 'Authorization: Bearer YOUR_ANON_KEY' \
     -H 'Content-Type: application/json' \
     -d '{
       "email": "test@example.com",
       "data": {
         "companyName": "Test Company",
         "inviterName": "John Doe",
         "role": "employee",
         "customMessage": "Welcome to our team!",
         "invitationLink": "https://yourapp.com/auth/accept-invitation/test123"
       }
     }'
   ```

### Production Testing

1. Send a test invitation through the UI
2. Check the browser console for logged invitation details
3. Manually send the email using the generated content
4. Verify the invitation link works

## 📝 Manual Email Sending (Current Workaround)

Until email service is configured, you can manually send invitations:

1. **Send invitation through UI**
2. **Check browser console** for logged details:
   ```javascript
   {
     email: "user@example.com",
     companyName: "Acme Corp",
     inviterName: "John Doe",
     role: "employee",
     customMessage: "Welcome!",
     invitationLink: "https://yourapp.com/auth/accept-invitation/abc123"
   }
   ```
3. **Copy the invitation link**
4. **Send via your preferred method** (Slack, email, etc.)

## 🔒 Security Considerations

- ✅ Invitation tokens expire in 7 days
- ✅ Tokens are unique and non-guessable
- ✅ Only authenticated users can send invitations
- ✅ Rate limiting should be implemented
- ✅ Email addresses are validated

## 📊 Monitoring

### Logs

Monitor Edge Function logs:
```bash
supabase functions logs send-invitation-email
```

### Metrics

Track invitation success rates:
- Invitations sent
- Invitations accepted
- Invitations expired
- Email delivery failures

## 🚨 Troubleshooting

### Common Issues

1. **Function not deployed:**
   - Run `./deploy-edge-function.sh`
   - Check Supabase CLI login status

2. **Email not sending:**
   - Check environment variables
   - Verify email service configuration
   - Check function logs

3. **Invitation link not working:**
   - Verify token exists in database
   - Check token expiration
   - Ensure proper URL format

### Debug Mode

Enable debug logging in the Edge Function:
```typescript
console.log('Debug info:', { email, data, response })
```

## 📚 Resources

- [Supabase Edge Functions Documentation](https://supabase.com/docs/guides/functions)
- [SendGrid API Documentation](https://docs.sendgrid.com/api-reference)
- [AWS SES Documentation](https://docs.aws.amazon.com/ses/)
- [Mailgun API Documentation](https://documentation.mailgun.com/)

## 🎯 Next Steps

1. ✅ Deploy Edge Function
2. ✅ Test invitation system
3. 🔄 Configure email service (SendGrid/AWS SES/Mailgun)
4. 🔄 Set up monitoring and logging
5. 🔄 Implement rate limiting
6. 🔄 Add email templates customization
7. 🔄 Set up analytics and tracking
